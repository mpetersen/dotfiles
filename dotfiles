#!/bin/bash
# .dotfiles installation script for Mac OS X

base_dir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

# Setup cloud folders
function cmd_cloud {
    cloudbase=~/Clouds
    cloudfolders=(
        #"Box Sync"
        #"Creative Cloud Files"
        "Dropbox"
        "drivesync"
        #"OneDrive"
        #"ownCloud"
    )
    basefolders=(
        "Documents"
        "Movies"
        "Music"
        "Pictures"
    )

    for c in "${cloudfolders[@]}" ; do
        mkdir -vp $cloudbase/"$c"
    done

    for b in "${basefolders[@]}" ; do
        for l in ~/"$b"/* ; do
            t=$(readlink "$l")
            if [[ $t == /Users/*/Clouds/* ]] ; then
                echo "Removing $l"
                unlink "$l"
            fi
        done
    done

    for c in "${cloudfolders[@]}" ; do
        for b in "${basefolders[@]}" ; do
            for d in $cloudbase/"$c"/"$b"/* ; do
                n=$(basename "$d")
                t=~/"$b"/"$n"
                [ -d "$d" ] && [ ! -s "$t" ] && ln -sv "$d" "$t ($c)"
            done
        done
    done
}

# Setup dock
function cmd_dock {
    dockutil --remove all --no-restart

    apps=(
        "/Applications/Utilities/Console.app"
        "/Applications/iTerm.app"
        "/Applications/Cyberduck.app"
        "/Applications/MacPass.app"
        "/Applications/Contacts.app"
        "/Applications/Mail.app"
        "/Applications/Messages.app"
        "/Applications/Safari.app"
        "/Applications/Calendar.app"
        "/Applications/Microsoft OneNote.app"
    )

    for app in "${apps[@]}"; do
        dockutil --add "$app" --no-restart
    done

    dockutil --add '/Applications' --view grid --display folder --sort name --no-restart
    dockutil --add '~/Downloads' --view grid --display stack --sort dateadded --no-restart
    dockutil --add '~' --view grid --display folder --sort kind --no-restart

    killall Dock
}

# Syntax:
# 
#   install file cmd regex
# 
# Runs the install `cmd` for each line of the file, filtered with the regex
# 
function install {
    install_file=$1
    install_cmd=$2
    install_regex=$3
    while read line; do
        id=`echo $line | sed -E "s/$install_regex|.*/\1/"`
        $install_cmd $id
    done <$install_file
}

# Backup default configuration
[ ! -f ~/.dotfiles/defaults.orig ] && defaults read > ~/.dotfiles/defaults.orig

# Update brew
brew update

# Install software
install $base_dir/install/brew-cask-list "brew cask install --appdir=/Applications" "(.*)"
install $base_dir/install/brew-list "brew install" "(.*)"
install $base_dir/install/mas-list "mas install" "([^ ]*).*"

# Cleanup
brew cleanup
brew cask cleanup

# Reload quicklook
qlmanage -r

# Setup dock
cmd_dock

# Setup cloud folders
cmd_cloud

# Install dotfiles
for dotfile in $base_dir/repo/* ; do
    name=$(basename "$dotfile")
    [ ! -s ~/.$name ] && ln -sv $base_dir/repo/$name ~/.$name
done

# Create private exports file
[ -e ~/.exports_private ] || touch ~/.exports_private

exit 0
